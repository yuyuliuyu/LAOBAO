/**
*
* Photobooth.js version 0.7
*
* build Sun Dec 02 2012 18:07:12 GMT+0000 (GMT Standard Time)
*
* JS
*/
Photobooth=function(e){e.length&&(e=e[0]);var t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.oGetUserMedia||navigator.msieGetUserMedia||!1;this.onImage=function(){},this.pause=function(){f===!1&&(f=!0,l&&l.stop&&l.stop())},this.debug=function(type,string){},this.resume=function(){f===!0&&(f=!1,A())},this.destroy=function(){this.pause(),e.removeChild(g)},this.status="",this.forceHSB=!1,this.isSupported=!!t,this.resize=function(e,t){h=e,p=t,T.setMax(h,p),g.style.width=e+"px",g.style.height=t+"px",y.width=e,y.height=t,w.width=e,w.height=t,S.width=e,S.height=t};var n=function(e){e.stopPropagation(),e.cancelBubble=!0};i=function(e,t,r){this.setMax=function(e,n){t=e,r=n},this.getData=function(){return{x:i,y:s,width:o,height:u}},this.isActive=function(){return h},this.toggle=function(){h===!1?(p.style.opacity=1,h=!0):(p.style.opacity=0,h=!1)};var i=30,s=30,o=100,u=100,a=30,f=30,l=100,c=100,h=!1},s=0,o=0,u=0,a=!1,f=!1,l=null,c=this,h=e.offsetWidth,p=e.offsetHeight,d=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1000/60)},v=function(e){return g.getElementsByClassName(e)[0]},m=function(e){return document.createElement(e)},this.hidden=function(h){h.style.display="none"},g=m("div");g.className="photobooth",g.id="web_camera",g.innerHTML='<div class="blind"></div><canvas></canvas></div>';var y=m("canvas"),b=y.getContext("2d"),w=g.getElementsByTagName("canvas")[0],E=w.getContext("2d"),S=m("video");S.autoplay=!0;var T=new i(g,h,p);var C=v("blind");this.capture=function(){C.className="blind",C.style.opacity=1,setTimeout(function(){C.className="blind anim",C.style.opacity=0},50);var e={};T.isActive()?e=T.getData():a?e={x:(h-S.videoWidth)/2,y:(p-S.videoHeight)/2,width:S.videoWidth,height:S.videoHeight}:e={x:0,y:0,width:h,height:p};var t=m("canvas");t.width=e.width,t.height=e.height;if(a){t.getContext("2d").drawImage(S,Math.max(0,e.x-(h-S.videoWidth)/2),Math.max(e.y-(p-S.videoHeight)/2),e.width,e.height,0,0,e.width,e.height)}else{var n=E.getImageData(e.x,e.y,e.width,e.height);t.getContext("2d").putImageData(n,0,0)}c.onImage(t.toDataURL())};var k=function(e){l=e;try{c.status="success";S.src=(window.URL||window.webkitURL).createObjectURL(l),d(D),c.debug("info","success")}catch(t){S.mozSrcObject=l,c.forceHSB===!1?(a=!0,g.appendChild(S),g.getElementsByTagName("ul")[0].className="noHSB"):S.addEventListener("canplay",function(){d(D)},!1),S.play()}},L=function(e){c.status="fail";c.hidden(g);c.debug("error","no camera")},A=function(){t.call(navigator,{video:!0},k,L)},O=function(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<0.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e},M=function(e){return e>1?e-1:e<0?1+e:e},_=function(e){return e>1?1:e<0?0:e},D=function(){b.drawImage(S,0,0,h,p);var e=b.getImageData(0,0,h,p),t=e.data;for(var n=0;n<t.length;n+=4){var r=t[n]/255,i=t[n+1]/255,a=t[n+2]/255,l=Math.max(r,i,a),c=Math.min(r,i,a),v,m,g=(l+c)/2;if(l==c){v=m=0}else{var y=l-c;m=g>0.5?y/(2-l-c):y/(l+c),l===r&&(v=((i-a)/y+(i<a?6:0))/6),l===i&&(v=((a-r)/y+2)/6),l===a&&(v=((r-i)/y+4)/6)}v=M(v+s),m=_(m+o),g=_(g+u);if(m===0){r=i=a=g}else{var w=g<0.5?g*(1+m):g+m-g*m,x=2*g-w;r=O(x,w,v+1/3),i=O(x,w,v),a=O(x,w,v-1/3)}t[n]=r*255,t[n+1]=i*255,t[n+2]=a*255}E.putImageData(e,0,0),f===!1&&d(D)};this.resize(h,p),e.appendChild(g),d(A)};