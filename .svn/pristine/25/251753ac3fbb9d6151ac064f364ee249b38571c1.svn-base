package com.lingnet.hcm.dao.impl.salary;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.apache.commons.lang3.StringUtils;
import org.hibernate.SQLQuery;
import org.hibernate.criterion.CriteriaSpecification;
import org.hibernate.criterion.Restrictions;
import org.springframework.stereotype.Repository;

import com.lingnet.common.dao.impl.BaseDaoImplInit;
import com.lingnet.hcm.dao.salary.SalaryRecordDao;
import com.lingnet.hcm.entity.salary.Rate;
import com.lingnet.hcm.entity.salary.SalaryRecord;
import com.lingnet.hcm.service.salary.RateService;
import com.lingnet.util.JsonUtil;
import com.lingnet.util.LingUtil;
import com.lingnet.util.Pager;

/**
 * 工资档案
 * @ClassName: SalaryRecordDao 
 * @Description: TODO 
 * @author zhanghj
 * @date 2017年3月23日 下午5:12:18 
 *
 */
@Repository("salaryRecordDao")
public class SalaryRecordDaoImpl extends BaseDaoImplInit<SalaryRecord, String> implements SalaryRecordDao {

    @Resource(name="rateService")
    private RateService rateService;

    @Override
    public Map<String, Object> getStaffSalaryListData(String id, String deptId, String searchData, Pager pager) {
        StringBuilder sql = new StringBuilder();
        sql.append("  SELECT                                                                                                        ");
        sql.append("  JBI.ID, MIN(JBI.JOB_NUMBER) jobNumber, MIN(JBI.NAME) name, MIN(BRANCH.FZX) fzx, MIN(JBI.SEX) sex, MIN(JBI.AGE) age, MIN(JBI.PHONE) phone,");
        sql.append("  MIN(QD.NAME) DEPTNAME,MIN(JBI.POST_ID) postId,MIN(JBI.POST) post,WM_CONCAT(SG.NAME) SALARYGROUP          ");
        sql.append("  FROM JC_BASIC_INFORMATION JBI                                                                                 ");
        sql.append("  LEFT JOIN XC_SALARY_PERSONAL SP                                                                                    ");
        sql.append("  ON SP.SALARY_RECORD_ID = JBI.ID                                                                                  ");
        sql.append("  LEFT JOIN QX_DEPARTMENT QD                                                                                    ");
        sql.append("  ON QD.ID = JBI.DEPART_ID                                                                                  ");
        sql.append("  LEFT JOIN BRANCH                                                                                    ");
        sql.append("  ON JBI.FILM_ID = BRANCH.ID                                                                                  ");
        sql.append("  LEFT JOIN XC_SALARY_GROUP SG                                           ");
        sql.append("  ON SP.SALARY_GROUP_ID = SG.ID                                           ");
        sql.append("   WHERE JBI.IS_DELETE = 0                                       ");
        if (!StringUtils.isBlank(id)) {
            sql.append("  AND JBI.ID = '"+id+"' ");
        }

        Map<String, String> mapData = JsonUtil.parseProperties(searchData);
        if (mapData != null) {
            // 工号
            if (!StringUtils.isBlank(mapData.get("jobNumber"))) {
                sql.append("   AND JBI.JOB_NUMBER LIKE '%"+mapData.get("jobNumber").trim()+"%'                                        ");
            }
            // 姓名
            if (!StringUtils.isBlank(mapData.get("name"))) {
                sql.append("   AND JBI.NAME LIKE '%"+mapData.get("name").trim()+"%'                                        ");
            }
            // 部门
            if (!StringUtils.isBlank(mapData.get("depId"))) {
                String[] deptArray = mapData.get("depId").split(",");
                sql.append("  AND JBI.DEPART_ID IN ('"+StringUtils.join(deptArray, "','")+"') ");
            }
            // 存在薪资组
            if (!StringUtils.isBlank(mapData.get("group"))) {
                // 存在
                if (mapData.get("group").equals("1")) {
                    sql.append("  AND NVL2(SP.SALARY_GROUP_ID, 1, 0) = 1");
                } else {// 不存在
                    sql.append("  AND NVL2(SP.SALARY_GROUP_ID, 1, 0) = 0");
                }
            }

        }
        sql.append("   GROUP BY JBI.ID,JBI.CREATEDATE                                        ");
        sql.append("   ORDER BY JBI.CREATEDATE DESC                                        ");

        pager = findPagerBySql(pager, sql.toString());
        List<?> list = pager.getResult();
        List<HashMap<String, Object>> dataList = new ArrayList<HashMap<String, Object>>();
        for (int i=0, l = list.size(); i < l; i++) {
            Object[] obj = (Object[]) list.get(i);
            HashMap<String, Object> map = new HashMap<String, Object>();
            map.put("id", obj[0]);
            map.put("jobNumber", obj[1]);
            map.put("name", obj[2]);
            map.put("companyId", obj[3]);
            map.put("detpName", obj[7]);
            map.put("sex", obj[4]);
            map.put("age", obj[5]);
            map.put("phone", obj[6]);
            map.put("post", obj[9]);
            map.put("salaryGroup", obj[10]);
            dataList.add(map);
        }
        Map<String, Object> map = new HashMap<String, Object>();
        map.put("data", dataList);
        map.put("total", pager.getTotalCount());

        return map;
    }

    @SuppressWarnings("unchecked")
    @Override
    public Map<String, Object> getStaffSalaryData(String id) {
        StringBuilder sql = new StringBuilder();
        sql.append("  SELECT                                                                                                        ");
        sql.append("  JBI.ID, JBI.JOB_NUMBER, JBI.NAME, JBI.SEX,JBI.AGE,JBI.PHONE, JBI.ID_TYPE,JBI.ID_NUMBER, JBI.EMP_TYPE, 'joinarmydate', 'xiaxiang',          ");
        sql.append("  JBI.SET_WORK_DATE, 'rusi date', 'ht date', JBI.LABOR_COMPANY, JBI.IN_PORT_TIME,JBI.IN_PORT_TIME2, 'kjgl', 'jl', ");
        sql.append("  NVL(SR.FILM_NAME, JBI.FILM_NAME) FILM_NAME, NVL(SR.DEPTNAME, QD2.NAME) DEPTNAME, NVL(SR.CLASS_NO, CC.CLASS_NO) CLASS_NO,          ");
        sql.append("  NVL(QD.NAME, SR.KQNAME) KQNAME, 'kqbm', 'kqbz', NVL(SR.POST, JBI.POST) POST, NVL(SR.SPECIFIC_POST, JBI.SPECIFIC_POST) SPECIFIC_POST, ");
        sql.append("  'xcgw', NVL(SR.IS_JZ, NVL2(JPJ.IS_HOST_POST, DECODE(JPJ.IS_HOST_POST, 0, 1, 1, 0), 0)) sfjz, SR.IS_BZGS, JBI.IS_SPECIAL_HOUR, JBI.CLASS_GROUP          ");
        sql.append("  FROM JC_BASIC_INFORMATION JBI                                                                                 ");
        sql.append("  LEFT JOIN XC_SALARY_RECORD SR                                                                                 ");
        sql.append("  ON JBI.ID = SR.STAFF_ID                                                                                       ");
        sql.append("  LEFT JOIN QX_DEPARTMENT QD                                                                                    ");
        sql.append("  ON QD.ID = JBI.CHECK_UNIT_ID                                                                                  ");
        sql.append("  LEFT JOIN QX_DEPARTMENT QD2                                                                                    ");
        sql.append("  ON QD2.ID = JBI.DEPART_ID                                                                                  ");
        sql.append("  LEFT JOIN BRANCH                                                                                    ");
        sql.append("  ON JBI.FILM_ID = BRANCH.ID                                                                                  ");
        sql.append("  LEFT JOIN CK_CLASS CC                                                                                    ");
        sql.append("  ON JBI.CLASS_NO = CC.CLASS_NO                                                                                  ");
        sql.append("  LEFT JOIN JC_PT_JOB JPJ                                                                                    ");
        sql.append("  ON JBI.JOB_NUMBER = JPJ.PERSON_ID                                                                                  ");
        sql.append("   WHERE JBI.IS_DELETE = 0                                       ");
        sql.append("    AND JBI.ID = '"+id+"' ");

//        List<?> list = findBySql(sql.toString());
//        List<HashMap<String, Object>> dataList = new ArrayList<HashMap<String, Object>>();
//        for (int i=0, l = list.size(); i < l; i++) {
//            Object[] obj = (Object[]) list.get(i);
//            HashMap<String, Object> map = new HashMap<String, Object>();
//            map.put("id", obj[0]);
//            map.put("jobNumber", obj[1]);
//            map.put("name", obj[2]);
//            map.put("companyId", obj[3]);
//            map.put("detpName", obj[7]);
//            map.put("sex", obj[4]);
//            map.put("age", obj[5]);
//            map.put("phone", obj[6]);
//            map.put("post", obj[9]);
//            dataList.add(map);
//        }
        SQLQuery query = getSession().createSQLQuery(sql.toString());
        query.setResultTransformer(CriteriaSpecification.ALIAS_TO_ENTITY_MAP);
        List<Map<String, Object>> list = query.list();
        Map<String, Object> map = new HashMap<String, Object>();
        if (list.size() > 0) {
            map = list.get(0);
        }

        return map;
    }

    @Override
    public List<Map<String, Object>> getSalaryStandardItems(String id, int type) {
        StringBuilder sql = new StringBuilder();
        sql.append("   SELECT                                                     ");
        sql.append("   MIN(JBI.ID) id,MIN(JBI.NAME) name,MIN(SI.NAME) SALARYNAME,  ");
        sql.append("   MIN(SV.STATIC_VALUE) SV  ");
        sql.append("   FROM XC_SALARY_PERSONAL SP                                 ");
        sql.append("   LEFT JOIN XC_SALARY_GROUP_WAGE WAGE                        ");
        sql.append("   ON SP.SALARY_GROUP_ID = WAGE.SALARY_GROUP_ID               ");
        sql.append("   AND WAGE.IS_DELETE = 0                                     ");
        sql.append("   LEFT JOIN XC_GROUP_WAGE_AND_TYPE WAT                       ");
        sql.append("   ON WAGE.ID = WAT.WAGE_ID                                   ");
        sql.append("   AND WAT.IS_DELETE = 0                                      ");
        sql.append("   RIGHT JOIN XC_SALARY_ITEMS SI                              ");
        sql.append("   ON WAT.ITEM_ID = SI.ID                                     ");
        sql.append("   AND SI.IS_DELETE = 0                                       ");
        sql.append("   LEFT JOIN JC_BASIC_INFORMATION JBI                         ");
        sql.append("   ON JBI.ID = SP.SALARY_RECORD_ID                            ");
        sql.append("   LEFT JOIN XC_SALARY_VALUE SV                               ");
        sql.append("   ON SV.STAFF_ID = JBI.ID                                    ");
        sql.append("   AND SV.SALARY_ITEMS_ID = SI.ID                             ");
        sql.append("   WHERE SP.IS_DELETE = 0                                     ");
        sql.append("   AND JBI.ID = '"+id+"'                                      ");

        switch (type) {
        case 1:// 固定薪资项目
            sql.append("   AND SI.FIXED = 1                                           ");
            break;
        case 2:// 异动项目
            sql.append("   AND SI.YD = 1                                           ");
            break;
        case 3:// 标准类项目
            sql.append("   AND SI.BZL = 1                                           ");
            break;
        case 4:// 年金类项目
            sql.append("   AND SI.NJL = 1                                           ");
            break;
        case 5:// 统筹类项目
            sql.append("   AND SI.TCL = 1                                           ");
            break;

        default:
            break;
        }

        sql.append("   group by SI.ID,SI.CREATEDATE                               ");
        sql.append("   ORDER BY SI.CREATEDATE ASC                                 ");

        List<?> list = findBySql(sql.toString());
        List<Map<String, Object>> dataList = new ArrayList<Map<String, Object>>();
        for (int i=0, l = list.size(); i < l; i++) {
            Object[] obj = (Object[]) list.get(i);
            HashMap<String, Object> map = new HashMap<String, Object>();
            map.put("id", obj[0]);
            map.put("name", obj[1]);
            map.put("salaryName", obj[2]);
            map.put("staticValue", obj[3]);
            dataList.add(map);
        }

        return dataList;
    }

    @Override
    public Map<String, Object> getHistorySalaryRecord(String id) {
        Map<String, Object> m = new HashMap<String, Object>();
        return m;
    }

    @Override
    public Map<String, Object> getPracticeEmployeeListData(String depId, Pager pager) {
        StringBuilder sql = new StringBuilder();
        sql.append("  SELECT                                                                    ");
        sql.append("  JBI.ID, JBI.JOB_NUMBER, JBI.NAME, BRANCH.FZX, JBI.SEX, JBI.AGE, JBI.PHONE,");
        sql.append("  QD.NAME DEPTNAME,JBI.POST_ID,JBI.POST,JBI.JOB_LEVEL,JBI.BEGIN_TIME,          ");
        sql.append("  SR.JS_TYPE,SR.START_DATE kaishi,SR.EFFECT_DATE          ");
        sql.append("  FROM JC_BASIC_INFORMATION JBI                                              ");
        sql.append("  LEFT JOIN QX_DEPARTMENT QD                                                 ");
        sql.append("  ON QD.ID = JBI.DEPART_ID                                                   ");
        sql.append("  LEFT JOIN BRANCH                                                           ");
        sql.append("  ON JBI.FILM_ID = BRANCH.ID                                                 ");
        sql.append("  LEFT JOIN XC_SALARY_RECORD SR                                               ");
        sql.append("  ON SR.STAFF_ID = JBI.ID                                                 ");
        sql.append("  WHERE JBI.IS_DELETE = 0                                       ");
        String searchData = pager.getSearchData();
        Map<String, String> search = JsonUtil.parseProperties(searchData);
        if (!StringUtils.isBlank(search.get("depId"))) {
            String[] deptArray = search.get("depId").split(",");
            sql.append("  AND JBI.DEPART_ID IN ('"+StringUtils.join(deptArray, "','")+"') ");
        }

        pager = findPagerBySql(pager, sql.toString());
        List<?> list= pager.getResult();
        List<HashMap<String, Object>> dataList = new ArrayList<HashMap<String, Object>>();
        for (int i=0, l = list.size(); i < l; i++) {
            Object[] obj = (Object[]) list.get(i);
            HashMap<String, Object> map = new HashMap<String, Object>();
            map.put("id", obj[0]);
            map.put("jobNumber", obj[1]);
            map.put("name", obj[2]);
            map.put("companyId", obj[3]);
            map.put("detpName", obj[7]);
            map.put("sex", obj[4]);
            map.put("age", obj[5]);
            map.put("phone", obj[6]);
            map.put("post", obj[9]);
            map.put("jobLevel", obj[10]);
            map.put("beginTime", obj[11]);
            Rate rate = rateService.get(Rate.class, Restrictions.eq("id", "2"));
            Double v = 0d;
            if (rate != null && obj[12] != null) {
                if (Integer.valueOf(obj[12].toString()) == 1) {
                    v = rate.getNativeMoney();
                } else if (Integer.valueOf(obj[12].toString()) == 2) {
                    v = rate.getForeignMoney();
                }
            }
            map.put("qzd", v);
            map.put("jsType", obj[12]);
            map.put("startDate", obj[13]);
            map.put("effectDate", obj[14]);
            dataList.add(map);
        }
        Map<String, Object> map = new HashMap<String, Object>();
        map.put("data", dataList);
        map.put("total", pager.getTotalCount());

        return map;
    }

    @SuppressWarnings({ "rawtypes", "unchecked" })
    @Override
    public Map<String, Object> getEmployeeBaseInfo(String id) {
        StringBuilder sql = new StringBuilder();
        sql.append("  SELECT                                                                    ");
        sql.append("  JBI.ID, JBI.JOB_NUMBER, JBI.NAME, BRANCH.FZX, JBI.SEX, JBI.AGE, JBI.PHONE,");
        sql.append("  QD.NAME DEPTNAME,JBI.POST_ID,JBI.POST,JBI.JOB_LEVEL,BRANCH.ID bId          ");
        sql.append("  FROM JC_BASIC_INFORMATION JBI                                              ");
        sql.append("  LEFT JOIN QX_DEPARTMENT QD                                                  ");
        sql.append("  ON QD.ID = JBI.DEPART_ID                                                    ");
        sql.append("  LEFT JOIN BRANCH                                                           ");
        sql.append("  ON JBI.FILM_ID = BRANCH.ID                                                 ");
        sql.append("  WHERE JBI.IS_DELETE = 0                                       ");
        sql.append("    AND JBI.ID = '"+id+"'                                       ");

        List list = findBySql(sql.toString());
        List<Object[]> listObj = list;
        Map<String, Object> map = new HashMap<String, Object>();
        if (listObj.size() == 0) {
            return map;
        }
        Object[] obj = (Object[]) listObj.get(0);
        map.put("id", obj[0]);
        map.put("jobNumber", obj[1]);
        map.put("name", obj[2]);
        map.put("company", obj[3]);
        map.put("detpName", obj[7]);
        map.put("sex", obj[4]);
        map.put("age", obj[5]);
        map.put("phone", obj[6]);
        map.put("post", obj[9]);
        map.put("jobLevel", obj[10]);
        map.put("companyId", obj[11]);

        return map;
    }

    @Override
    public List<Map<String, Object>> getSalaryGroupValueListData(String id) {
        StringBuilder sql = new StringBuilder();
        sql.append("   SELECT                                                       ");
        sql.append("   SV.ID,SV.SALARY_GROUP_ID, SG.NAME GROUPNAME, SV.SALARY_ITEMS_ID,   ");
        sql.append("   ITEMS.NAME ITEMNAME,SV.STATIC_VALUE,ITEMS.NUMBER_ACCURACY   ");
        sql.append("   FROM XC_SALARY_VALUE SV                                      ");
        sql.append("   LEFT JOIN XC_SALARY_GROUP SG                                 ");
        sql.append("   ON SV.SALARY_GROUP_ID = SG.ID                                ");
        sql.append("   LEFT JOIN XC_SALARY_ITEMS ITEMS                              ");
        sql.append("   ON SV.SALARY_ITEMS_ID = ITEMS.ID                             ");
        sql.append("   WHERE SV.STAFF_ID='"+id+"' AND SV.IS_DELETE = 0                    ");
        sql.append("   ORDER BY SV.CREATEDATE ASC                                 ");

        List<?> list = findBySql(sql.toString());
        List<Map<String, Object>> dataList = new ArrayList<Map<String, Object>>();
        for (int i=0, l = list.size(); i < l; i++) {
            Object[] obj = (Object[]) list.get(i);
            HashMap<String, Object> map = new HashMap<String, Object>();
            map.put("id", obj[0]);
            map.put("salaryGroupId", obj[1]);
            map.put("groupName", obj[2]);
            map.put("salaryItemsId", obj[3]);
            map.put("itemName", obj[4]);
            map.put("staticValue", obj[5]);
            map.put("target", obj[6]);
            dataList.add(map);
        }

        return dataList;
    }

    @Override
    public Map<String, Object> getAllSalaryAdjustListData(String depId, String searchData, Pager pager) {
        StringBuilder sql = new StringBuilder();
        sql.append("     SELECT JBI.ID,                                        ");
        sql.append("       MIN(JBI.JOB_NUMBER) JOBNUMBER,                      ");
        sql.append("       MIN(JBI.NAME) NAME,                                 ");
        sql.append("       MIN(BRANCH.FZX) FZX,                                ");
        sql.append("       MIN(QD.NAME) DEPTNAME,                              ");
        sql.append("       MIN(JBI.POST_ID) POSTID,                            ");
        sql.append("       MIN(JBI.POST) POST,                                 ");
        sql.append("       MIN(JBI.JOB_LEVEL) jobLevel,                        ");
        sql.append("       MIN(JBI.ON_JOB) onJob,                        ");
        sql.append("       WM_CONCAT(SV.SALARY_ITEMS_ID) WMID,                 ");
        sql.append("       WM_CONCAT(ITEMS.NAME) WMNAME,                        ");
        sql.append("       WM_CONCAT(SV.STATIC_VALUE) VALUE                        ");
        sql.append("     FROM JC_BASIC_INFORMATION JBI                         ");
        sql.append("     LEFT JOIN QX_DEPARTMENT QD                            ");
        sql.append("       ON QD.ID = JBI.DEPART_ID                              ");
        sql.append("     LEFT JOIN BRANCH                                      ");
        sql.append("       ON JBI.FILM_ID  = BRANCH.ID                           ");
        sql.append("     LEFT JOIN XC_SALARY_VALUE SV                          ");
        sql.append("       ON JBI.ID = SV.STAFF_ID                               ");
        sql.append("     AND SV.IS_DELETE=0                                    ");
        sql.append("     LEFT JOIN XC_SALARY_ITEMS ITEMS                       ");
        sql.append("       ON SV.SALARY_ITEMS_ID = ITEMS.ID                      ");
        sql.append("     WHERE JBI.IS_DELETE = 0                ");
        Map<String, String> search = JsonUtil.parseProperties(searchData);

        if (search != null) {
            // 部门
            if (!StringUtils.isBlank(search.get("depId"))) {
                String[] deptArray = search.get("depId").split(",");
                sql.append("  AND JBI.DEPART_ID IN ('"+StringUtils.join(deptArray, "','")+"') ");
            }
            // 工号
            if (!StringUtils.isBlank(search.get("jobNumber"))) {
                sql.append("  AND JBI.JOB_NUMBER LIKE '%"+search.get("jobNumber").trim()+"%'");
            }
            // 姓名
            if (!StringUtils.isBlank(search.get("name"))) {
                sql.append("  AND JBI.NAME LIKE '%"+search.get("name").trim()+"%'");
            }
            // 薪资组
            if (!StringUtils.isBlank(search.get("salaryGroup"))) {
                sql.append("  AND SV.SALARY_GROUP_ID = '"+search.get("salaryGroup").trim()+"'");
            }
        }
        sql.append("     GROUP BY JBI.ID, JBI.CREATEDATE                       ");
        sql.append("     ORDER BY JBI.CREATEDATE DESC                          ");

        pager = findPagerBySql(pager, sql.toString());
        List<?> list= pager.getResult();
        List<HashMap<String, Object>> dataList = new ArrayList<HashMap<String, Object>>();
        for (int i=0, l = list.size(); i < l; i++) {
            Object[] obj = (Object[]) list.get(i);
            HashMap<String, Object> map = new HashMap<String, Object>();
            map.put("id", obj[0]);
            map.put("jobNumber", obj[1]);
            map.put("name", obj[2]);
            map.put("company", obj[3]);
            map.put("detpName", obj[4]);
            map.put("post", obj[6]);
            map.put("jobLevel", obj[7]);
            map.put("onJob", obj[8]);
            map.put("wmName", obj[10]);
            map.put("staticValue", obj[11]);
            dataList.add(map);
        }
        Map<String, Object> map = new HashMap<String, Object>();
        map.put("data", dataList);
        map.put("total", pager.getTotalCount());

        return map;
    }

    @Override
    public List<Map<String, Object>> getStaffForAdjustListData(String ids) {
        StringBuilder sql = new StringBuilder();
        sql.append("     SELECT JBI.ID,                                        ");
        sql.append("       MIN(JBI.JOB_NUMBER) JOBNUMBER,                      ");
        sql.append("       MIN(JBI.NAME) NAME,                                 ");
        sql.append("       MIN(BRANCH.FZX) FZX,                                ");
        sql.append("       MIN(QD.NAME) DEPTNAME,                              ");
        sql.append("       MIN(JBI.POST_ID) POSTID,                            ");
        sql.append("       MIN(JBI.POST) POST,                                 ");
        sql.append("       MIN(JBI.JOB_LEVEL) jobLevel,                        ");
        sql.append("       MIN(JBI.ON_JOB) onJob,                        ");
        sql.append("       WM_CONCAT(SV.SALARY_ITEMS_ID) WMID,                 ");
        sql.append("       WM_CONCAT(ITEMS.NAME) WMNAME,                        ");
        sql.append("       WM_CONCAT(SV.STATIC_VALUE) VALUE,                    ");
        sql.append("       WM_CONCAT(ITEMS.NUMBER_ACCURACY) NUMBER_ACCURACY,    ");
        sql.append("       WM_CONCAT(SV.ID) svId                               ");
        sql.append("     FROM JC_BASIC_INFORMATION JBI                         ");
        sql.append("     LEFT JOIN QX_DEPARTMENT QD                            ");
        sql.append("       ON QD.ID = JBI.DEPART_ID                              ");
        sql.append("     LEFT JOIN BRANCH                                      ");
        sql.append("       ON JBI.FILM_ID  = BRANCH.ID                           ");
        sql.append("     LEFT JOIN XC_SALARY_VALUE SV                          ");
        sql.append("       ON JBI.ID = SV.STAFF_ID                               ");
        sql.append("     AND SV.IS_DELETE=0                                    ");
        sql.append("     LEFT JOIN XC_SALARY_ITEMS ITEMS                       ");
        sql.append("       ON SV.SALARY_ITEMS_ID = ITEMS.ID                      ");
        sql.append("     WHERE JBI.IS_DELETE = 0                ");

        if (!StringUtils.isBlank(ids)) {
            String[] deptArray = ids.split(",");
            sql.append("  AND JBI.ID IN ('"+StringUtils.join(deptArray, "','")+"') ");
        }
        sql.append("     GROUP BY JBI.ID                       ");

        List<?> list= findBySql(sql.toString());
        List<Map<String, Object>> dataList = new ArrayList<Map<String, Object>>();
        for (int i=0, l = list.size(); i < l; i++) {
            Object[] obj = (Object[]) list.get(i);
            HashMap<String, Object> map = new HashMap<String, Object>();
            map.put("id", obj[0]);
            map.put("jobNumber", obj[1]);
            map.put("name", obj[2]);
            map.put("company", obj[3]);
            map.put("detpName", obj[4]);
            map.put("post", obj[6]);
            map.put("jobLevel", obj[7]);
            map.put("onJob", obj[8]);
            map.put("wmId", obj[9]);
            map.put("wmName", obj[10]);
            map.put("staticValue", obj[11]);
            map.put("xs", obj[12]);
            map.put("svId", obj[13]);
            dataList.add(map);
        }

        return dataList;
    }

    @Override
    public List<Map<String, String>> getAllGroupFinancialList(String id) {
        StringBuilder sql = new StringBuilder();
        sql.append("   SELECT *                                                     ");
        sql.append("   FROM                                                         ");
        sql.append("     (SELECT SF.ID, SF.CONTENT, WAT.SX                          ");
        sql.append("     FROM XC_SALARY_FORMULA SF                                  ");
        sql.append("     LEFT JOIN XC_GROUP_WAGE_AND_TYPE WAT                       ");
        sql.append("       ON WAT.ID         = SF.BIND_ID                             ");
        sql.append("     WHERE WAT.ITEM_ID = '"+id+"'     ");
        sql.append("       AND SF.IS_DELETE  = 0                                      ");
        sql.append("       AND WAT.IS_DELETE =0                                       ");
        sql.append("     UNION ALL                                                  ");
        sql.append("      SELECT SF.ID, SF.CONTENT, WAT.SX                          ");
        sql.append("     FROM XC_SALARY_FORMULA SF                                  ");
        sql.append("     LEFT JOIN XC_SALARY_WAGE_AND_TYPE wat                      ");
        sql.append("       ON WAT.ID         = SF.BIND_ID                             ");
        sql.append("     WHERE WAT.ITEM_ID = '"+id+"'     ");
        sql.append("       AND SF.IS_DELETE  = 0                                      ");
        sql.append("       AND WAT.IS_DELETE =0                                       ");
        sql.append("     ) c                                                        ");
        sql.append("   ORDER BY c.SX ASC                                            ");

        List<?> list = findBySql(sql.toString());
        List<Map<String, String>> dataList = new ArrayList<Map<String, String>>();
        for (int i=0, l = list.size(); i < l; i++) {
            Object[] obj = (Object[]) list.get(i);
            HashMap<String, String> map = new HashMap<String, String>();
            map.put("id", obj[0]+"");
            try {
                map.put("content", LingUtil.ClobToString((java.sql.Clob)obj[1]));
            } catch (Exception e) {
                map.put("content", "");
            }
            map.put("type", "1");
            dataList.add(map);
        }
        HashMap<String, String> map = new HashMap<String, String>();
        map.put("id", "0");
        map.put("content", "简单计算公式");
        map.put("type", "2");
        dataList.add(map);

        return dataList;
    }

    @Override
    public Map<String, Object> getAllRecordHistoryListData(String staffId, Pager pager) {
        StringBuilder sql = new StringBuilder();
        sql.append("    SELECT SH.ID, SI.NAME,                 ");
        sql.append("      SH.ADJUST_FRONT,              ");
        sql.append("      SH.ADJUST_NEXT,               ");
        sql.append("      SH.ADJUST_DATE,               ");
        sql.append("      SH.NOTE                       ");
        sql.append("    FROM XC_SALARY_HISTORY SH       ");
        sql.append("    LEFT JOIN XC_SALARY_ITEMS SI    ");
        sql.append("      ON SH.ITEMS_ID = SI.ID          ");
        sql.append("    LEFT JOIN JC_BASIC_INFORMATION JBI    ");
        sql.append("      ON SH.STAFF_ID = JBI.ID          ");
        sql.append("    WHERE SH.STAFF_ID = '"+staffId+"'          ");
        Map<String, String> search = JsonUtil.parseProperties(pager.getSearchData());
        if (search != null) {
            // 工号
            if (!StringUtils.isBlank(search.get("jobNumber"))) {
                sql.append("  AND JBI.JOB_NUMBER LIKE '%"+search.get("jobNumber")+"%' ");
            }

            // 姓名
            if (!StringUtils.isBlank(search.get("name"))) {
                sql.append("  AND JBI.NAME LIKE '%"+search.get("name")+"%' ");
            }
        }

        sql.append("     ORDER BY SH.CREATEDATE DESC                          ");

        pager = findPagerBySql(pager, sql.toString());
        List<?> list= pager.getResult();
        List<HashMap<String, Object>> dataList = new ArrayList<HashMap<String, Object>>();
        for (int i=0, l = list.size(); i < l; i++) {
            Object[] obj = (Object[]) list.get(i);
            HashMap<String, Object> map = new HashMap<String, Object>();
            map.put("id", obj[0]);
            map.put("name", obj[1]);
            map.put("adjustFront", obj[2]);
            map.put("adjustNext", obj[3]);
            map.put("adjustDate", obj[4]);
            map.put("note", obj[5]);
            dataList.add(map);
        }
        Map<String, Object> map = new HashMap<String, Object>();
        map.put("data", dataList);
        map.put("total", pager.getTotalCount());

        return map;
    }

}
